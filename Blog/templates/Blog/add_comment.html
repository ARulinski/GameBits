{% load static %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
    .comment-section {
        background-color: #2b2b2b;
        padding: 20px;
        border-radius: 8px;
        max-height: 400px; 
        overflow-y: auto;
        color: #f1f1f1;
        font-family: Arial, sans-serif;
    }

    .comment, .reply {
        background-color: #444;
        margin-bottom: 20px;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        display: flex;
        justify-content: space-between;
    }

    .comment .comment-content, .reply .reply-content {
        display: flex;
        align-items: flex-start;
    }

    .comment-details, .reply-details {
        display: flex;
        flex-direction: column;
    }

    .avatar1 {
        border-radius: 50%;
        width: 40px;
        height: 40px;
        margin-right: 15px;
        border: 2px solid #3bc8e4;
    }

    .username {
        color: #3bc8e4;
        font-weight: bold;
    }

    .comment-date {
        font-size: 12px;
        color: #bbb;
        margin-top: 5px;
    }
    
    .comment-actions, .reply-actions {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .comment-actions .action-item, .reply-actions .action-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        cursor: pointer;
        color: #f1f1f1;
        font-size: 14px;
        text-decoration: none;
    }

    .comment-actions .action-item i, .reply-actions .action-item i {
        margin-right: 5px;
    }

    .comment-actions .action-item:hover, .reply-actions .action-item:hover {
        color: #3bc8e4;
    }

    .comment-form {
        margin-top: 10px;
        padding: 20px;
        background-color: #333;
        border-radius: 8px;
    }

    .comment-form textarea, .reply-form textarea {
        width: 100%;
        min-height: 50px;
        max-height: 60px;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #666;
        background-color: #444;
        color: #f1f1f1;
        margin-bottom: 10px;
        resize: vertical;
        box-sizing: border-box;
        font-size: 16px;
        line-height: 1.5;
    }

    .comment-form button, .reply-form button {
        align-items: center;
        background-color: #3bc8e4;
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    @media (max-width: 600px) {
        .comment-section, .comment-form, .reply-form {
            padding: 10px;
        }

        .comment, .reply {
            padding: 10px;
        }

        .comment-form textarea, .reply-form textarea {
            padding: 10px;
        }

        .comment-form button, .reply-form button {
            padding: 10px;
            font-size: 14px;
        }

        .comment-actions .action-item, .reply-actions .action-item {
            font-size: 16px;
        }
    }

    .nocomment {
        color: #f1f1f1;
        text-align: center;
    }

    .nested-replies-container {
        margin-left: 20px;
        padding-left: 20px;
        border-left: 2px solid #555;
    }

    .body {
        color: #ddd;
    }
</style>

<div class="comment-section">
    {% if not comments %}
        <h3 class="nocomment">No comments yet..</h3>
    {% else %}
        {% for comment in comments %}
            <div class="comment">
                <div class="comment-content">
                    <img src="{{ comment.name.avatar.url }}" alt="{{ comment.name.username }}" class="avatar1">
                    <div class="comment-details">
                        <strong class="username">{{ comment.name.username }}</strong>
                        <span class="comment-date">{{ comment.date_added }}</span>
                        <p class="body">{{ comment.comment_body }}</p>
                    </div>
                </div>
                <div class="comment-actions">
                    <div class="action-item reply-btn" data-comment-id="{{ comment.id }}">
                        <i class="fas fa-reply"></i><span>Reply</span>
                    </div>
                    <br/>
                    <br/>
                    {% if request.user.is_authenticated and comment.name == request.user %}
                        <div class="action-item">
                            <i class="fas fa-trash"></i><span>Delete</span>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Nested Replies Container -->
            <div class="nested-replies-container">
                {% if comment.replies.all %}
                    {% for reply in comment.replies.all %}
                        <div class="reply">
                            <div class="reply-content">
                                <img src="{{ reply.name.avatar.url }}" alt="{{ reply.name.username }}" class="avatar1">
                                <div class="reply-details">
                                    <strong class="username">{{ reply.name.username }}</strong>
                                    <span class="comment-date">{{ reply.date_added }}</span>
                                    <p class="body">{{ reply.reply_body }}</p>
                                </div>
                            </div>
                            <div class="reply-actions">
                                <div class="action-item reply-btn" data-comment-id="{{ reply.comment.id }}" data-reply-id="{{ reply.id }}">
                                    <i class="fas fa-reply"></i><span>Reply</span>
                                </div>
                                <br/>
                                <br/>
                                {% if request.user.is_authenticated and reply.name == request.user %}
                                    <div class="action-item">
                                        <i class="fas fa-trash"></i><span>Delete</span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        {% endfor %}
    {% endif %}
</div>

<!-- Comment Form -->
<div class="form-container comment-form">
    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" name="comment_form" class="submit-btn">Post Comment</button>
    </form>
</div>

<!-- Reply Form -->
<div class="form-container reply-form" style="display: none;">
    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="comment_id" value="" id="comment_id">
        <input type="hidden" name="reply_id" value="" id="reply_id">
        {{ form2.as_p }}
        <button type="submit" name="reply_form" class="submit-btn">Post Reply</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.reply-btn').forEach(function (button) {
            button.addEventListener('click', function () {
                const commentId = this.getAttribute('data-comment-id');
                const replyId = this.getAttribute('data-reply-id');
                const formContainer = document.querySelector('.reply-form');
                
                // Check if the reply form is already visible for the same comment or reply
                if (formContainer.style.display === 'block') {
                    // If it's visible, hide it
                    formContainer.style.display = 'none';
                    return;
                }

                // Populate the hidden fields
                document.getElementById('comment_id').value = commentId || '';
                document.getElementById('reply_id').value = replyId || '';

                // Move the form directly below the clicked comment or reply
                if (replyId) {
                    this.closest('.reply').appendChild(formContainer);
                } else {
                    this.closest('.comment').appendChild(formContainer);
                }

                // Show the reply form
                formContainer.style.display = 'block';
                formContainer.scrollIntoView({ behavior: 'smooth' });
            });
        });
    });
</script>

